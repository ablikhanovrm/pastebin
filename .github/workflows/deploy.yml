name: Deploy

on:
  push:
    branches:
      - main

permissions: # allow the workflow to read and write to the repo
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout  # load repo into runner
        uses: actions/checkout@v4

      - name: Login to GHCR  # authenticate to ghcr.io and pull the image
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image
        run: docker build -f infra/docker/Dockerfile -t ghcr.io/${{ github.repository_owner }}/pastebin:latest .

      - name: Push image
        run: docker push ghcr.io/${{ github.repository_owner }}/pastebin:latest

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/pastebin
  
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml pull
            
            HTTP_BIND_ADDRESS=0.0.0.0 \
            HTTP_PORT=8080 \
            APP_ENV=${{ secrets.APP_ENV }} \
            JWT_SECRET=${{ secrets.JWT_SECRET }} \
            SECURE_COOKIES=${{ secrets.SECURE_COOKIES }} \
            DB_NAME=${{ secrets.DB_NAME }} \
            DB_HOST=${{ secrets.DB_HOST }} \
            DB_PORT=${{ secrets.DB_PORT }} \
            DB_USER=${{ secrets.DB_USER }} \
            DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            DB_MIGRATOR_PASSWORD=${{ secrets.DB_MIGRATOR_PASSWORD }} \
            DB_MIGRATOR_USER=${{ secrets.DB_MIGRATOR_USER }} \
            DB_SSLMODE=${{ secrets.DB_SSLMODE }} \
            REDIS_HOST=${{ secrets.REDIS_HOST }} \
            REDIS_PORT=${{ secrets.REDIS_PORT }} \
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }} \
            S3_ENDPOINT=${{ secrets.S3_ENDPOINT }} \
            S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }} \
            S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }} \
            S3_BUCKET=${{ secrets.S3_BUCKET }} \
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            docker image prune -af